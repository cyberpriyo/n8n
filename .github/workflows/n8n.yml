name: n8n-hosting

on:
  workflow_dispatch: # Allows manual start and restart via script

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Max allowed by GitHub
    permissions:
      contents: write # Required to push backups

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore Latest Backup
        run: |
          if [ -d "backups" ] && [ "$(ls -A backups)" ]; then
            echo "üìÇ Backups found. Restoring the latest one..."
            # Get the latest tar.gz file
            LATEST_BACKUP=$(ls -t backups/*.tar.gz | head -n 1)
            echo "Restoring from: $LATEST_BACKUP"
            tar -xzf "$LATEST_BACKUP"
            echo "‚úÖ Restore complete."
          else
            echo "üÜï No backups found. Starting fresh instance."
          fi
          # Set permissions so Docker can write to it
          chmod -R 777 n8n-data

      - name: Start n8n Container
        run: |
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_SECURE_COOKIE=false \
            n8nio/n8n
          
          echo "Waiting for n8n to boot..."
          sleep 15

      - name: Start Tunnel & Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # 1. Install Cloudflared
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          # 2. Run Tunnel
          # We output to a log file so we can scrape the URL
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel URL to generate..."
          sleep 10
          
          # 3. Extract URL
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
             echo "‚ùå Failed to get URL. Logs:"
             cat tunnel.log
          else
             echo "üîó Generated URL: $TUNNEL_URL"
             
             # 4. Send to Discord
             # Uses a nice embed format
             curl -H "Content-Type: application/json" \
                  -d "{\"embeds\": [{\"title\": \"üöÄ n8n is Online!\", \"description\": \"**URL:** $TUNNEL_URL\n**Next Reset:** ~5.5 Hours\", \"color\": 5814783}]}" \
                  $DISCORD_WEBHOOK
          fi

      - name: Run Backup & Restart Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # Passes your PAT to the script
        run: |
          chmod +x backup.sh
          ./backup.sh

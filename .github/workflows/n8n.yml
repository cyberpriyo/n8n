name: n8n-hosting

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore & Decrypt Backup
        env:
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
        run: |
          if [ -f "backups/backup_latest.enc" ]; then
            echo "ðŸ” Encrypted backup found. Decrypting..."
            # Using -iter 10000 to match backup script
            if openssl enc -d -aes-256-cbc -pbkdf2 -iter 10000 -in "backups/backup_latest.enc" -out "restored.tar.gz" -k "$BACKUP_PASSWORD"; then
                echo "âœ… Decryption successful."
                tar -xzf "restored.tar.gz"
                rm "restored.tar.gz"
            else
                echo "âŒ Decryption failed. Password might be wrong."
            fi
          else
            echo "ðŸ†• No backup found. Starting fresh."
          fi
          chmod -R 777 n8n-data

      - name: Start n8n Container
        run: |
          docker run -d \
            --name n8n \
            --network host \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_PORT=5678 \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL="https://n8n-priyo.vercel.app/api/proxy" \
            -e VUE_APP_URL_BASE_API="https://n8n-priyo.vercel.app/api/proxy" \
            n8nio/n8n
          
          echo "â³ Waiting for n8n to boot..."
          until curl -s -f -o /dev/null "http://localhost:5678/healthz"; do
            sleep 5
            echo "Still waiting..."
          done
          echo "âœ… n8n is UP!"

      - name: Start Tunnel & Update Vercel
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          echo "â³ Waiting for Tunnel URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
             TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
             if [ ! -z "$TUNNEL_URL" ]; then
                break
             fi
             sleep 2
          done

          if [ -z "$TUNNEL_URL" ]; then
             echo "âŒ Tunnel failed."
             cat tunnel.log
             exit 1
          fi

          echo "âœ… Tunnel Online: $TUNNEL_URL"
          
          # Stabilize
          sleep 30
          
          echo "$TUNNEL_URL" > n8n_url.txt
          
          git config --global user.email "bot@n8n.com"
          git config --global user.name "URL Bot"
          git pull --rebase --autostash
          git add n8n_url.txt
          git commit -m "Update Active URL"
          git push

          curl -H "Content-Type: application/json" \
               -d "{\"embeds\": [{\"title\": \"ðŸš€ n8n Online\", \"description\": \"**Stable:** https://n8n-priyo.vercel.app\n**Direct:** $TUNNEL_URL\", \"color\": 5814783}]}" \
               $DISCORD_WEBHOOK

      - name: Run Backup & Restart Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} 
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }} 
        run: |
          chmod +x backup.sh
          ./backup.sh
name: n8n-hosting

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Rclone
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf
          echo "âœ… Rclone installed and configured."

      - name: Restore from Google Drive
        run: |
          mkdir -p n8n-data
          REMOTE="gdrive:"
          BACKUP_FOLDER="n8n_backups"
          
          echo "ðŸ” Checking for backups on Google Drive..."
          if rclone copy "$REMOTE$BACKUP_FOLDER/backup_1.tar.gz" . 2>/dev/null; then
             echo "âœ… Found backup_1.tar.gz. Extracting..."
             tar -xzf backup_1.tar.gz
             rm backup_1.tar.gz
          else
             echo "ðŸ†• No backup found on Drive. Starting fresh."
          fi
          chmod -R 777 n8n-data

      - name: Start n8n Container
        env:
          N8N_BASIC_AUTH_ACTIVE: "true"
          N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
        run: |
          docker run -d \
            --name n8n \
            --network host \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_PORT=5678 \
            -e N8N_SECURE_COOKIE=false \
            -e N8N_BASIC_AUTH_ACTIVE=$N8N_BASIC_AUTH_ACTIVE \
            -e N8N_BASIC_AUTH_USER=$N8N_BASIC_AUTH_USER \
            -e N8N_BASIC_AUTH_PASSWORD=$N8N_BASIC_AUTH_PASSWORD \
            -e WEBHOOK_URL="https://n8n-priyo.vercel.app/api/proxy" \
            -e VUE_APP_URL_BASE_API="https://n8n-priyo.vercel.app/api/proxy" \
            n8nio/n8n
          
          echo "â³ Waiting for n8n to boot..."
          for i in {1..12}; do
            if curl -s -f "http://localhost:5678/healthz"; then
              echo "âœ… n8n is UP!"
              break
            fi
            sleep 5
          done

      - name: Start Tunnel & Notify
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          echo "â³ Waiting for Tunnel URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
             TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
             if [ ! -z "$TUNNEL_URL" ]; then
                break
             fi
             sleep 2
          done

          if [ -z "$TUNNEL_URL" ]; then
             echo "âŒ Tunnel failed."
             exit 1
          fi

          echo "âœ… URL: $TUNNEL_URL"
          echo "$TUNNEL_URL" > n8n_url.txt
          
          git config --global user.email "bot@n8n.com"
          # --- CHANGED NAME HERE ---
          git config --global user.name "n8n-hosting-bot"
          
          git pull origin main --rebase || echo "No changes"
          git add n8n_url.txt
          git commit -m "Update Active URL"
          git push

          curl -H "Content-Type: application/json" \
               -d "{\"embeds\": [{\"title\": \"ðŸš€ n8n Online (GDrive)\", \"description\": \"**Proxy:** https://n8n-priyo.vercel.app\n**Direct:** $TUNNEL_URL\", \"color\": 3066993}]}" \
               $DISCORD_WEBHOOK

      - name: Run Backup Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} 
        run: |
          chmod +x backup.sh
          ./backup.sh

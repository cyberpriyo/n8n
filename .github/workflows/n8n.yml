name: n8n-hosting

on:
  workflow_dispatch: # Allows manual start

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Max
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore & Decrypt Backup
        env:
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
        run: |
          if [ -f "backups/backup_latest.enc" ]; then
            echo "ðŸ” Encrypted backup found. Decrypting..."
            # Uses -iter 10000 to match backup script
            if openssl enc -d -aes-256-cbc -pbkdf2 -iter 10000 -in "backups/backup_latest.enc" -out "restored.tar.gz" -k "$BACKUP_PASSWORD"; then
                echo "âœ… Decryption successful."
                if [ -f "restored.tar.gz" ]; then
                    echo "ðŸ“‚ Unzipping data..."
                    tar -xzf "restored.tar.gz"
                    rm "restored.tar.gz"
                    echo "âœ… Data restored."
                else
                    echo "âŒ Error: Decrypted file is missing."
                fi
            else
                echo "âŒ Decryption failed. Password might be incorrect or file corrupted."
            fi
          else
            echo "ðŸ†• No backup found. Starting fresh."
          fi
          chmod -R 777 n8n-data

      - name: Start n8n Container
        run: |
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL="https://n8n-priyo.vercel.app/api/proxy" \
            -e VUE_APP_URL_BASE_API="https://n8n-priyo.vercel.app/api/proxy" \
            n8nio/n8n
          
          # Wait for n8n to be ready locally first
          echo "â³ Waiting for n8n to boot..."
          until curl -s -f -o /dev/null "http://localhost:5678/healthz"; do
            sleep 5
            echo "Still waiting for n8n..."
          done
          echo "âœ… n8n is running locally!"

      - name: Start Tunnel & Update Vercel
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # 1. Start Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          # Start tunnel and log to file
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          # 2. Smart Wait for URL (Up to 60 seconds)
          echo "â³ Waiting for Tunnel URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
             TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
             if [ ! -z "$TUNNEL_URL" ]; then
                echo "âœ… Found URL: $TUNNEL_URL"
                break
             fi
             sleep 2
          done

          if [ -z "$TUNNEL_URL" ]; then
             echo "âŒ Tunnel failed to generate URL."
             cat tunnel.log
             exit 1
          fi

          # 3. Health Check the Tunnel
          echo "â³ Verifying Tunnel Stability..."
          sleep 5 
          
          # 4. Update Vercel Pointer
          echo "$TUNNEL_URL" > n8n_url.txt
          
          git config --global user.email "bot@n8n.com"
          git config --global user.name "URL Bot"
          git pull --rebase --autostash
          git add n8n_url.txt
          git commit -m "Update Active URL"
          git push

          # 5. Notify Discord
          curl -H "Content-Type: application/json" \
               -d "{\"embeds\": [{\"title\": \"ðŸš€ n8n Online\", \"description\": \"**Stable URL:** https://n8n-priyo.vercel.app\n**Direct:** $TUNNEL_URL\", \"color\": 5814783}]}" \
               $DISCORD_WEBHOOK

      - name: Run Backup & Restart Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} 
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }} 
        run: |
          chmod +x backup.sh
          ./backup.sh
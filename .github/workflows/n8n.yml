name: n8n-hosting

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours max
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore & Decrypt Backup
        env:
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
        run: |
          # We always look for backup_1.enc (The latest one)
          if [ -f "backups/backup_1.enc" ]; then
            echo "ðŸ” Found latest backup (backup_1.enc). Decrypting..."
            if openssl enc -d -aes-256-cbc -pbkdf2 -iter 10000 -in "backups/backup_1.enc" -out "restored.tar.gz" -k "$BACKUP_PASSWORD"; then
                echo "âœ… Decryption successful."
                tar -xzf "restored.tar.gz"
                rm "restored.tar.gz"
            else
                echo "âŒ Decryption failed. Check Password."
            fi
          else
            echo "ðŸ†• No backup found. Starting fresh instance."
          fi
          chmod -R 777 n8n-data

      - name: Start n8n Container
        run: |
          docker run -d \
            --name n8n \
            --network host \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_PORT=5678 \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL="https://n8n-priyo.vercel.app/api/proxy" \
            -e VUE_APP_URL_BASE_API="https://n8n-priyo.vercel.app/api/proxy" \
            n8nio/n8n
          
          echo "â³ Waiting for n8n to boot..."
          # Wait up to 60 seconds for n8n
          for i in {1..12}; do
            if curl -s -f "http://localhost:5678/healthz"; then
              echo "âœ… n8n is UP!"
              break
            fi
            sleep 5
          done

      - name: Start Tunnel & Notify
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          # Start Tunnel
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          echo "â³ extracting Tunnel URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
             TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
             if [ ! -z "$TUNNEL_URL" ]; then
                break
             fi
             sleep 2
          done

          if [ -z "$TUNNEL_URL" ]; then
             echo "âŒ Tunnel failed to start."
             exit 1
          fi

          echo "âœ… URL: $TUNNEL_URL"
          
          # 1. Update GitHub file for Vercel Proxy
          echo "$TUNNEL_URL" > n8n_url.txt
          
          # Git config for the URL update
          git config --global user.email "bot@n8n.com"
          git config --global user.name "URL Bot"
          
          # We need to pull first because the repo might have changed
          git pull origin main --rebase || echo "No changes to pull"
          git add n8n_url.txt
          git commit -m "Update Active URL"
          git push

          # 2. Send Discord Notification
          curl -H "Content-Type: application/json" \
               -d "{\"embeds\": [{\"title\": \"ðŸš€ n8n Started (Loop)\", \"description\": \"**Proxy:** https://n8n-priyo.vercel.app\n**Direct:** $TUNNEL_URL\n\n*Recovered latest backup automatically.*\", \"color\": 3066993}]}" \
               $DISCORD_WEBHOOK

      - name: Run Backup Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} 
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }} 
        run: |
          chmod +x backup.sh
          ./backup.sh

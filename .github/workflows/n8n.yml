name: n8n-hosting

on:
  workflow_dispatch: # Manual button to start
  schedule:
    - cron: '0 */6 * * *' # Restart every 6 hours

jobs:
  run-server:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push backups

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore Latest Backup
        run: |
          # Check if backups folder exists and has files
          if [ -d "backups" ] && [ "$(ls -A backups)" ]; then
            echo "Backups found. Restoring the latest one..."
            # Get the latest backup file
            LATEST_BACKUP=$(ls -t backups/*.tar.gz | head -n 1)
            echo "Restoring from: $LATEST_BACKUP"
            tar -xzf "$LATEST_BACKUP"
            echo "Restore complete."
          else
            echo "No backups found. Starting fresh."
          fi
          # Fix permissions for Docker
          chmod -R 777 n8n-data

      - name: Start n8n container
        run: |
          # Run n8n using the local n8n-data folder
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            n8nio/n8n
          
          echo "Waiting for n8n to initialize..."
          sleep 10

      - name: Start Cloudflared Tunnel & Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # 1. Install Cloudflared
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          # 2. Start Tunnel in background and log to file
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          
          # 3. Wait for URL to be generated
          echo "Waiting for Tunnel URL..."
          sleep 10
          
          # 4. Extract URL from logs
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
             echo "Failed to get URL. Printing logs:"
             cat tunnel.log
          else
             echo "Generated URL: $TUNNEL_URL"
             
             # 5. Send to Discord
             curl -H "Content-Type: application/json" \
                  -d "{\"content\": \"üöÄ **n8n is Online!**\nüîó URL: $TUNNEL_URL\n‚è∞ Next reset in ~6 hours.\"}" \
                  $DISCORD_WEBHOOK
          fi

      - name: Run Backup Loop
        run: |
          chmod +x backup.sh
          ./backup.sh

name: n8n-hosting

on:
  workflow_dispatch: # Allows manual start

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Max
    permissions:
      contents: write # Crucial for updating the URL file

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Data Directory
        run: mkdir -p n8n-data

      - name: Restore & Decrypt Backup
        env:
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
        run: |
          # Check if the encrypted file exists
          if [ -f "backups/backup_latest.enc" ]; then
            echo "ðŸ” Encrypted backup found. Decrypting..."
            
            # 1. Decrypt (enc -> tar.gz)
            # If password is wrong, this fails safely
            openssl enc -d -aes-256-cbc -pbkdf2 -in "backups/backup_latest.enc" -out "restored.tar.gz" -k "$BACKUP_PASSWORD"
            
            # 2. Unzip (tar.gz -> folder)
            if [ -f "restored.tar.gz" ]; then
                echo "ðŸ“‚ Unzipping data..."
                tar -xzf "restored.tar.gz"
                rm "restored.tar.gz"
                echo "âœ… Data restored successfully."
            else
                echo "âŒ Decryption failed. Password might be wrong."
            fi
          else
            echo "ðŸ†• No backup found. Starting fresh."
          fi
          
          # Fix permissions for Docker
          chmod -R 777 n8n-data

      - name: Start n8n Container
        # REPLACE THE URL BELOW WITH YOUR VERCEL DOMAIN
        run: |
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -v $(pwd)/n8n-data:/home/node/.n8n \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL=https://n8n-priyo.vercel.app/api/proxy \
            -e VUE_APP_URL_BASE_API=https://n8n-priyo.vercel.app/api/proxy \
            n8nio/n8n
          
          sleep 15

      - name: Start Tunnel & Update Vercel
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # 1. Start Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          nohup cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          sleep 10
          
          # 2. Get URL
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
             echo "âŒ Tunnel failed."
             exit 1
          else
             echo "ðŸ”— New URL: $TUNNEL_URL"
             
             # 3. Update Vercel Pointer (n8n_url.txt)
             echo "$TUNNEL_URL" > n8n_url.txt
             
             git config --global user.email "bot@n8n.com"
             git config --global user.name "URL Bot"
             git pull --rebase --autostash # Pull first to avoid conflicts
             git add n8n_url.txt
             git commit -m "Update Active URL"
             git push

             # 4. Notify Discord
             # Sends your STABLE Vercel Link to Discord
             curl -H "Content-Type: application/json" \
                  -d "{\"embeds\": [{\"title\": \"ðŸš€ n8n Online\", \"description\": \"**Stable URL:** https://n8n-priyo.vercel.app\n**Direct:** $TUNNEL_URL\", \"color\": 5814783}]}" \
                  $DISCORD_WEBHOOK
          fi

      - name: Run Backup & Restart Loop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # Uses your PAT to trigger the next run
          BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }} # Needed for encryption
        run: |
          chmod +x backup.sh
          ./backup.sh
